# Model Serving

如果您希望将模型文件部署到自己的生产环境中，可以用[EasyRecProcessor](https://help.aliyun.com/zh/pai/user-guide/easyrec)或者[tensorflow serving](https://github.com/tensorflow/serving) 的方式部署。EasyRecProcessor针对推荐模型做了深度优化, 相比tensorflow serving和TensorRT方式部署具有显著的[性能优势](./processor.md)。 我们推荐使用阿里云上的[模型在线服务(PAI-EAS)](https://help.aliyun.com/document_detail/113696.html)预置的EasyRecProcessor 来进行在线推理。

## 命令行部署

```bash
#!/bin/bash
bizdate=$1

cat << EOF > alirec_rank.json
{
 "name": "alirec_rank",
 "generate_token": "true",
 "processor": "easyrec-1.5",
 "metadata":{
    "instance": 1,
    "cpu": 16,
    "gpu": 0,
    "memory": 8000,
    "rpc": {
       "enable_jemalloc": 1,
       "max_queue_size": 256,
       "worker_threads": 20
    }
 },
 "model_config": {
    "fg_mode": "bypass",
    "save_req": false
 },
 "storage": [
    {
      "mount_path": "/home/admin/docker_ml/workspace/model/",
      "oss": {
        "path": "oss://easyrec-bj/alirec_rank/20230819/export/final/",
        "readOnly": false
      },
      "properties": {
        "resource_type": "code"
      }
    }
 ],
 "warm_up_data_path": "oss://easyrec-bj/alirec_rank/warmup.bin"
}
EOF
cat alirec_rank.json

### 创建服务
eascmd -i <AccessKeyID> -k <AccessKeySecret> \
-e <EndPoint> create alirec_rank.json

### 更新服务
echo "-------------------更新服务-------------------"
eascmd -i <AccessKeyID> -k <AccessKeySecret> \
-e <EndPoint> \
modify alirec_rank -s alirec_rank.json

status=$?

### 查看服务
echo "-------------------查看服务-------------------"
eascmd -i <AccessKeyID> -k <AccessKeySecret>  \
-e <EndPoint> desc alirec_rank

```

配置文件(alirec_rank.json)解析:

- processor: easyrec-1.5, 更多版本可以参考[文档](./processor.md#Release)
- storage: 挂载oss模型目录
- warm_up_data_path: 用于warmup的请求, 格式同[TensorFlow服务请求](https://help.aliyun.com/document_detail/111055.html), 建议使用线上真实的请求来warmup, 能够显著降低初始请求的开销.
- model_config
  - fg_mode: bypass模式表示不使用fg(Feature generation)功能, 如需要使用FG请参考文档[RTP FG](../feature/rtp_fg.md).
  - save_req: 保存请求到挂载模型目录下(以.pb结尾), 可以重命名以后(.bin)作为warmup文件.
- 其它参数是所有EAS服务通用的, 请参考[EAS文档](https://help.aliyun.com/zh/pai/user-guide/parameters-of-model-services).

## UI界面部署

请参考[EAS部署文档](https://help.aliyun.com/document_detail/110985.html).

## 客户端请求

模型部署到线上后，线上需构造请求数据，具体请参考文档[TensorFlow服务请求](https://help.aliyun.com/document_detail/111055.html).

## 特征工程

EasyRecProcessor支持在线做特征工程(如显示交叉特征和Sequence特征), 并针对相关的功能做了深度优化, 如果您需要用到特征工程的部分，可以参考文档[RTP FG](../feature/rtp_fg.md)

## 推荐引擎

PaiRec是Aliyun PAI开发的高性能推荐引擎框架, 支持通过配置的方式构建推荐全链路pipeline, 包括召回、过滤、排序、多样性等, 如果需要用到PaiRec进行在线推荐服务, 可以参考:
[入门介绍](http://pai-vision-data-hz.oss-cn-zhangjiakou.aliyuncs.com/pairec/docs/pairec/html/intro/intro.html)
[项目示例](http://pai-vision-data-hz.oss-cn-zhangjiakou.aliyuncs.com/pairec/docs/pairec/html/demo/pairec_demo.html)
[PaiRec部署服务](http://pai-vision-data-hz.oss-cn-zhangjiakou.aliyuncs.com/pairec/docs/pairec/html/deploy/eas.html)
